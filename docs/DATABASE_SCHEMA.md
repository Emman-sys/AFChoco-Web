# ðŸ“Š Database Schema - Aligned with Mobile Apps

**Firebase Project:** `anf-chocolate`  
**Web App:** AFChoco-Web  
**Mobile Apps:** AFMobile (User App) + AFAdmin (Admin App)  
**Schema Status:** âœ… **100% ALIGNED**

This document describes the exact Firestore database structure shared between the web application and both mobile applications.

---

## ðŸŽ¯ Schema Overview

All three applications (web, user mobile, admin mobile) use the **exact same Firestore collections and field names** to ensure seamless data synchronization.

---

## ðŸ“š Firestore Collections

### 1. **users** Collection

**Purpose:** Store user profile information  
**Document ID:** Firebase Auth UID  

```javascript
users/{userId}
  â”œâ”€ uid: String                    // Firebase Auth UID
  â”œâ”€ email: String                  // User's email address
  â”œâ”€ username: String               // Display name
  â”œâ”€ phoneNumber: String            // Contact number (optional)
  â”œâ”€ address: String                // Delivery address (optional)
  â”œâ”€ profilePicture: String         // URL to profile image (optional)
  â”œâ”€ role: String                   // "user" or "admin"
  â”œâ”€ createdAt: Timestamp           // Account creation date
  â””â”€ updatedAt: Timestamp           // Last profile update
```

**Example:**
```json
{
  "uid": "abc123xyz789",
  "email": "john@example.com",
  "username": "John Doe",
  "phoneNumber": "+639171234567",
  "address": "123 Main St, Manila",
  "profilePicture": "",
  "role": "user",
  "createdAt": Timestamp(2026, 2, 16, 10, 30),
  "updatedAt": Timestamp(2026, 2, 16, 10, 30)
}
```

**Access Rules:**
- Users can read their own profile
- Users can update their own profile
- Only admins can delete users

---

### 2. **products** Collection

**Purpose:** Store product catalog  
**Document ID:** Auto-generated by Firestore  

```javascript
products/{productId}
  â”œâ”€ name: String                   // Product name
  â”œâ”€ description: String            // Product description
  â”œâ”€ price: Double                  // Product price (decimal)
  â”œâ”€ category: String               // WHITE | DARK | MILK | MIXED | SPECIALTY
  â”œâ”€ sku: String                    // Stock Keeping Unit identifier
  â”œâ”€ stockLevel: Number             // Available inventory
  â”œâ”€ salesCount: Number             // Total units sold (auto-updated)
  â”œâ”€ imageUrl: String               // Firebase Storage URL or external URL
  â”œâ”€ createdAt: Timestamp           // Product creation date
  â””â”€ updatedAt: Timestamp           // Last product update
```

**Categories (Exact Values):**
- `WHITE` - White Chocolate
- `DARK` - Dark Chocolate
- `MILK` - Milk Chocolate
- `MIXED` - Mixed/Assorted Chocolate
- `SPECIALTY` - Specialty items

**Example:**
```json
{
  "name": "Sea Salt Caramels",
  "description": "Rich dark chocolate with sea salt caramel filling",
  "price": 15.99,
  "category": "DARK",
  "sku": "CHO-SSC-001",
  "stockLevel": 50,
  "salesCount": 125,
  "imageUrl": "https://firebasestorage.googleapis.com/.../products/uuid.jpg",
  "createdAt": Timestamp(2026, 1, 15, 8, 0),
  "updatedAt": Timestamp(2026, 2, 16, 14, 20)
}
```

**Access Rules:**
- Anyone can read products (public browsing)
- Only admins can create/update/delete products

**Cloud Function Automation:**
- `salesCount` is auto-incremented when orders are placed
- `stockLevel` is auto-decremented when orders are placed

---

### 3. **cart** Collection

**Purpose:** Store shopping cart items (individual documents, not nested)  
**Document ID:** Auto-generated by Firestore  

```javascript
cart/{cartItemId}
  â”œâ”€ userId: String                 // Owner's Firebase Auth UID
  â”œâ”€ productId: String              // Reference to product document ID
  â”œâ”€ productName: String            // Cached product name
  â”œâ”€ productPrice: Double           // Cached product price
  â”œâ”€ productImageUrl: String        // Cached product image
  â”œâ”€ quantity: Number               // Number of items
  â”œâ”€ addedAt: Timestamp             // When item was added to cart
  â””â”€ updatedAt: Timestamp           // Last quantity/price update
```

**Example:**
```json
{
  "userId": "abc123xyz789",
  "productId": "prod_xyz123",
  "productName": "Sea Salt Caramels",
  "productPrice": 15.99,
  "productImageUrl": "https://firebasestorage.googleapis.com/.../products/uuid.jpg",
  "quantity": 2,
  "addedAt": Timestamp(2026, 2, 16, 15, 10),
  "updatedAt": Timestamp(2026, 2, 16, 15, 10)
}
```

**Access Rules:**
- Users can only read/write their own cart items
- Query: `where('userId', '==', currentUserId).orderBy('addedAt', 'desc')`

**Notes:**
- Each cart item is a separate document
- Cart is NOT nested inside user document
- Cart is automatically cleared after successful checkout

---

### 4. **orders** Collection

**Purpose:** Store order history and tracking  
**Document ID:** Auto-generated by Firestore  

```javascript
orders/{orderId}
  â”œâ”€ userId: String                 // Customer's Firebase Auth UID
  â”œâ”€ userName: String               // Customer's display name
  â”œâ”€ userEmail: String              // Customer's email
  â”œâ”€ items: Array                   // Ordered products
  â”‚   â”œâ”€ productId: String
  â”‚   â”œâ”€ productName: String
  â”‚   â”œâ”€ productImageUrl: String
  â”‚   â”œâ”€ productPrice: Double
  â”‚   â””â”€ quantity: Number
  â”œâ”€ deliveryAddress: String        // Shipping address
  â”œâ”€ phoneNumber: String            // Contact number
  â”œâ”€ subtotal: Double               // Sum of (price Ã— quantity)
  â”œâ”€ deliveryFee: Double            // Shipping cost
  â”œâ”€ totalAmount: Double            // subtotal + deliveryFee
  â”œâ”€ orderStatus: String            // Order lifecycle status
  â”œâ”€ paymentStatus: String          // Payment state
  â”œâ”€ notes: String                  // Customer notes/instructions
  â”œâ”€ createdAt: Timestamp           // Order creation date
  â”œâ”€ paidAt: Timestamp | null       // Payment confirmation timestamp
  â”œâ”€ approvedAt: Timestamp | null   // Admin approval timestamp
  â”œâ”€ shippedAt: Timestamp | null    // Shipment dispatch timestamp
  â””â”€ deliveredAt: Timestamp | null  // Delivery completion timestamp
```

**Order Status Values:**
- `PENDING` - Order created, awaiting payment
- `PAID` - Payment received
- `APPROVED` - Admin approved order
- `PROCESSING` - Order being prepared
- `SHIPPED` - Order dispatched
- `DELIVERED` - Order completed
- `CANCELLED` - Order cancelled

**Payment Status Values:**
- `PENDING` - Awaiting payment
- `PAID` - Payment confirmed
- `VERIFIED` - Payment verified by admin

**Example:**
```json
{
  "userId": "abc123xyz789",
  "userName": "John Doe",
  "userEmail": "john@example.com",
  "items": [
    {
      "productId": "prod_xyz123",
      "productName": "Sea Salt Caramels",
      "productImageUrl": "https://...",
      "productPrice": 15.99,
      "quantity": 2
    }
  ],
  "deliveryAddress": "123 Main St, Manila, 1000",
  "phoneNumber": "+639171234567",
  "subtotal": 31.98,
  "deliveryFee": 50.00,
  "totalAmount": 81.98,
  "orderStatus": "SHIPPED",
  "paymentStatus": "PAID",
  "notes": "Please call before delivery",
  "createdAt": Timestamp(2026, 2, 16, 16, 0),
  "paidAt": Timestamp(2026, 2, 16, 16, 5),
  "approvedAt": Timestamp(2026, 2, 16, 18, 0),
  "shippedAt": Timestamp(2026, 2, 17, 9, 0),
  "deliveredAt": null
}
```

**Access Rules:**
- Users can only read their own orders
- Admins can read all orders
- Only admins can update order/payment status

**Cloud Function Automation:**
- When order created â†’ decrement `products.stockLevel`
- When order created â†’ increment `products.salesCount`
- Generate low stock alerts if stock < 10

---

### 5. **comments** Collection

**Purpose:** Store product reviews and comments  
**Document ID:** Auto-generated by Firestore  

```javascript
comments/{commentId}
  â”œâ”€ productId: String              // Reference to product
  â”œâ”€ userId: String                 // Commenter's Firebase Auth UID
  â”œâ”€ userName: String               // Commenter's display name
  â”œâ”€ text: String                   // Comment text
  â”œâ”€ rating: Number | null          // Star rating (1-5, optional)
  â”œâ”€ createdAt: Timestamp           // Comment creation date
  â””â”€ updatedAt: Timestamp           // Last edit date
```

**Example:**
```json
{
  "productId": "prod_xyz123",
  "userId": "abc123xyz789",
  "userName": "John Doe",
  "text": "Amazing chocolates! The sea salt adds the perfect touch.",
  "rating": 5,
  "createdAt": Timestamp(2026, 2, 16, 20, 0),
  "updatedAt": Timestamp(2026, 2, 16, 20, 0)
}
```

**Access Rules:**
- Anyone can read comments
- Only authenticated users can create comments
- Users can only edit/delete their own comments
- Admins can delete any comment

---

### 6. **alerts** Collection (Admin Only)

**Purpose:** Auto-generated alerts for admin dashboard  
**Document ID:** Auto-generated by Firestore  
**Created By:** Cloud Functions  

```javascript
alerts/{alertId}
  â”œâ”€ type: String                   // "LOW_STOCK" | "HIGH_SALES" | etc.
  â”œâ”€ productId: String              // Related product (if applicable)
  â”œâ”€ productName: String            // Product name for display
  â”œâ”€ currentStock: Number           // Current stock level
  â”œâ”€ threshold: Number              // Alert trigger threshold
  â”œâ”€ createdAt: Timestamp           // Alert creation time
  â””â”€ resolved: Boolean              // Whether alert has been addressed
```

**Example:**
```json
{
  "type": "LOW_STOCK",
  "productId": "prod_xyz123",
  "productName": "Sea Salt Caramels",
  "currentStock": 8,
  "threshold": 10,
  "createdAt": Timestamp(2026, 2, 16, 22, 0),
  "resolved": false
}
```

---

### 7. **analytics** Collection (Admin Only)

**Purpose:** Daily aggregated analytics  
**Document ID:** Date string (e.g., "2026-02-16")  
**Created By:** Cloud Functions (scheduled)  

```javascript
analytics/{date}
  â”œâ”€ date: Timestamp                // Date of analytics
  â”œâ”€ totalSales: Double             // Total revenue
  â”œâ”€ orderCount: Number             // Number of orders
  â”œâ”€ averageOrderValue: Double      // Average order amount
  â”œâ”€ lowStockCount: Number          // Products with low stock
  â””â”€ lowStockProducts: Array        // List of low stock product IDs
```

---

## ðŸ”„ Data Flow Between Apps

### Web App (AFChoco-Web)
- **Reads:** All collections
- **Writes:** All collections (admin operations)
- **Real-time:** Uses Firestore snapshot listeners for cart and orders

### User Mobile App (AFMobile)
- **Reads:** products, cart (own), orders (own), comments, users (own)
- **Writes:** cart (own), orders (create), comments (own), users (own profile)
- **Offline:** Products cached in SQLite for offline browsing

### Admin Mobile App (AFAdmin)
- **Reads:** All collections
- **Writes:** products, orders (status updates), alerts (resolve)
- **Real-time:** Dashboard with live analytics

---

## ðŸ” Security Rules Summary

```javascript
// Users
- Read: Own profile only (admins can read all)
- Write: Own profile only

// Products
- Read: Public (anyone)
- Write: Admin only

// Cart
- Read/Write: Own cart items only

// Orders
- Read: Own orders (admins can read all)
- Create: Any authenticated user
- Update: Admin only

// Comments
- Read: Public
- Create: Authenticated users
- Update/Delete: Owner or admin

// Alerts & Analytics
- Read: Admin only
- Write: Cloud Functions only
```

---

## ðŸ“Š Required Firestore Indexes

These composite indexes are required for queries:

1. **products** collection:
   - `category` ASC + `createdAt` DESC
   
2. **orders** collection:
   - `userId` ASC + `createdAt` DESC
   - `orderStatus` ASC + `createdAt` DESC
   
3. **cart** collection:
   - `userId` ASC + `addedAt` DESC
   
4. **comments** collection:
   - `productId` ASC + `createdAt` DESC

Deploy indexes with:
```bash
firebase deploy --only firestore:indexes
```

---

## ðŸš€ API Endpoints (Web App)

### Products
- `GET /api/products` - List products (with category filter)
- `GET /api/products/:id` - Get single product
- `POST /api/products` - Create product (admin)
- `PUT /api/products/:id` - Update product (admin)
- `DELETE /api/products/:id` - Delete product (admin)

### Cart
- `GET /api/cart` - Get user's cart
- `POST /api/cart/add` - Add item to cart
- `PUT /api/cart/update/:cartItemId` - Update quantity
- `DELETE /api/cart/remove/:cartItemId` - Remove item
- `DELETE /api/cart/clear` - Clear entire cart

### Orders
- `POST /api/orders/create` - Create new order
- `GET /api/orders/my-orders` - Get user's orders
- `GET /api/orders/:orderId` - Get single order
- `GET /api/orders/admin/all` - Get all orders (admin)
- `PUT /api/orders/:orderId/status` - Update order status (admin)

### Categories
- `GET /api/categories` - Get category list
- `GET /api/categories/stats` - Get products count by category

### Comments
- `GET /api/comments/product/:productId` - Get product comments
- `POST /api/comments` - Add comment
- `PUT /api/comments/:id` - Update comment
- `DELETE /api/comments/:id` - Delete comment

### Authentication
- `POST /api/auth/create-profile` - Create user profile
- `GET /api/auth/profile` - Get current user profile
- `PUT /api/auth/profile` - Update user profile

---

## âœ… Schema Validation Checklist

- [x] Products use `category` (string), not `category_id` (number)
- [x] Categories are: WHITE, DARK, MILK, MIXED, SPECIALTY
- [x] Cart items are individual documents, not nested arrays
- [x] Orders use camelCase field names (e.g., `orderStatus`)
- [x] Order statuses match mobile app values
- [x] Users have `username` field, not `firstName`/`lastName`
- [x] All timestamps use Firestore Timestamp type
- [x] Field names match exactly between web and mobile apps
- [x] Security rules allow anonymous product browsing
- [x] Firestore indexes configured for all queries

---

## ðŸŽ¯ Migration Notes

When migrating from MySQL:
1. Map old `category_id` (1-8) to new categories (WHITE, DARK, etc.)
2. Transform `first_name`/`last_name` to `username`
3. Convert snake_case fields to camelCase
4. Convert ISO date strings to Firestore Timestamps
5. Split nested cart arrays into individual documents
6. Update order status values to uppercase

---

**Last Updated:** February 16, 2026  
**Schema Version:** 1.0 (Mobile App Compatible)  
**Status:** âœ… Production Ready
